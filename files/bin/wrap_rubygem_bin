#!/usr/bin/env bash
# set -ex
command_name=$1
shift

find_bin() {
  bin_name=$1
  IFS=':' read -a paths <<< "$GEM_PATH"
  ruby_bin_dir=$(dirname `which ruby`)
  paths=(${paths[@]} "$ruby_bin_dir")

  for bin_dir in $paths; do
    bin_path="$bin_dir/bin/$bin_name"

    if [[ -x "$bin_path" ]]; then
      break
    fi
  done

  echo $bin_path
}

foreman_bin=$(find_bin foreman)
bundler_bin=$(find_bin bundle)
wrapped_bin=$(find_bin $command_name)

[[ -f `pwd`/Gemfile ]] && [[ -x "$bundler_bin" ]] && has_bundler=true
[[ -f `pwd`/Procfile ]] && [[ -x "$foreman_bin" ]] && has_foreman=true
[[ -f `pwd`/bin/$command_name ]] && has_local_bin=true

if [[ "$has_foreman" = true ]]; then
  cmd="foreman run"
fi

if [ "$has_bundler" = true ] && [ "$command_name" != "bundle" ]; then
  cmd="$cmd bundle exec"
fi

if [[ "$has_local_bin" = true ]]; then
  cmd="$cmd ./bin/$command_name"
elif [ -x "$wrapped_bin" ] && [ "$cmd" == "" ]; then
  cmd="$wrapped_bin"
else
  cmd="$cmd $command_name"
fi

$cmd $@
